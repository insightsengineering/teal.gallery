---
name: Deploy Apps ðŸš€

on:
  push:
    branches:
      - main
    tags:
      - "*"
  workflow_dispatch:
  schedule:
    - cron: "12 3 * * *"

concurrency:
  group: publish-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  SHINYAPPSIO_ACCOUNT: genentech
  APP_PREFIX: NEST

jobs:
  deploy:
    defaults:
      run:
        shell: bash
    name: Publish ðŸ—ž
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/insightsengineering/rstudio_4.3.1_bioc_3.17:latest
    if: >
      !contains(github.event.commits[0].message, '[skip deploy]')
    strategy:
      fail-fast: false
      matrix:
        directory:
          [
            "RNA-seq",
            "basic-teal",
            "efficacy",
            "exploratory",
            "longitudinal",
            "early-dev",
            "patient-profile",
            "python",
            "safety",
          ]
        repository:
          [
            "https://insightsengineering.r-universe.dev",
            "https://pharmaverse.r-universe.dev",
          ]
    steps:
      - name: Set APP_SUFFIX
        run: |
          if [ "${{ matrix.repository }}" = "https://insightsengineering.r-universe.dev" ]; then
            echo "APP_SUFFIX=release" >> $GITHUB_ENV
          else
            echo "APP_SUFFIX=main" >> $GITHUB_ENV
          fi

      - name: Checkout repo ðŸ›Ž
        uses: actions/checkout@v3
        with:
          path: ${{ github.event.repository.name }}

      - name: Check if cypress test exists
        id: find-cypress
        run: |
          if [ -d ${{ github.event.repository.name }}/${{ matrix.directory }}/tests/cypress ]; then
            echo "has-cypress-tests=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping frontend tests because cypress directory does not exist."
            echo "has-cypress-tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup system dependencies for cypress and python app
        if: steps.find-cypress.outputs.has-cypress-tests == 'true'
        run: >
          apt-get update && apt-get install --yes
          libgtk2.0-0 libgbm-dev libnotify-dev libgconf-2-4 xvfb python3.10-venv

      - name: Setup Node
        uses: actions/setup-node@v3
        if: steps.find-cypress.outputs.has-cypress-tests == 'true'
        with:
          node-version: 16

      - name: Setup npm packages
        if: steps.find-cypress.outputs.has-cypress-tests == 'true'
        shell: bash
        working-directory: ${{ github.event.repository.name }}/${{ matrix.directory }}/js
        run: |
          npm i

      - name: Install app dependencies
        shell: Rscript {0}
        run: |
          setwd("${{ github.event.repository.name }}/${{ matrix.directory }}")
          install.packages('remotes')
          remotes::install_version("rsconnect", "0.8.29")
          remotes::install_version("renv", "1.0.0")
          install.packages(
            renv::dependencies()$Package,
            repos = c(
              Pharmaverse = "${{ matrix.repository }}",
              CRAN = "https://cloud.r-project.org",
              BioC = BiocManager::repositories()
            )
          )

      - name: Front end test to check if the app works fine
        id: front-end-test
        continue-on-error: true
        if: steps.find-cypress.outputs.has-cypress-tests == 'true'
        uses: cypress-io/github-action@v2
        with:
          working-directory: ${{ github.event.repository.name }}/${{ matrix.directory }}/js
          start: npm run run-app
          wait-on: "http://localhost:3333"
          wait-on-timeout: 500
          project: ../tests

      - name: Generate skip status file
        if: steps.find-cypress.outputs.has-cypress-tests == 'false'
        run: |
          echo '{"schemaVersion": 1, "label": "Tests", "message": "skip", "color": "blue"}' > ${{ github.event.repository.name }}/${{ matrix.directory }}_${{ env.APP_SUFFIX }}.json
          cat ${{ github.event.repository.name }}/${{ matrix.directory }}_${{ env.APP_SUFFIX }}.json

      - name: Generate test status file
        if: steps.find-cypress.outputs.has-cypress-tests == 'true'
        run: |
          # Checks if the 'Front end test to check if the app works fine' step failed or succeed
          if [[ "${{ steps.front-end-test.outcome }}" == "success" ]]; then
            status='{"schemaVersion": 1, "label": "Tests", "message": "success", "color": "green"}'
          else
            status='{"schemaVersion": 1, "label": "Tests", "message": "fail", "color": "red"}'
          fi
          # echo the status into a json file associated with the directory name
          echo $status > ${{ github.event.repository.name }}/${{ matrix.directory }}_${{ env.APP_SUFFIX }}.json
          cat ${{ github.event.repository.name }}/${{ matrix.directory }}_${{ env.APP_SUFFIX }}.json

      - name: Deploy ðŸ–¨ ${{ matrix.directory }} ðŸŽ¨
        shell: Rscript {0}
        run: |
          options(
            repos = c(
              Pharmaverse = "${{ matrix.repository }}",
              CRAN = "https://cloud.r-project.org",
              BioC = BiocManager::repositories()
            )
          )
          rsconnect::setAccountInfo(
            name = "${{ env.SHINYAPPSIO_ACCOUNT }}",
            token = "${{ secrets.SHINYAPPSIO_TOKEN }}",
            secret = "${{ secrets.SHINYAPPSIO_SECRET }}",
            server = "shinyapps.io"
          )
          rsconnect::deployApp(
            appDir = "./${{ github.event.repository.name }}/${{ matrix.directory }}",
            appFiles = "app.R",
            appName = rsconnect::generateAppName("${{ env.APP_PREFIX }}_${{ matrix.directory }}_${{ env.APP_SUFFIX }}"),
            appTitle = "${{ env.APP_PREFIX }}_${{ matrix.directory }}_${{ env.APP_SUFFIX }}",
            account = "${{ env.SHINYAPPSIO_ACCOUNT }}",
            upload = TRUE,
            logLevel = "normal",
            lint = FALSE,
            forceUpdate = TRUE
          )

      - name: Commit test status files
        uses: EndBug/add-and-commit@v7
        continue-on-error: true
        with:
          author_name: GitHub Actions
          author_email: actions@github.com
          branch: test-stats
          message: "Update test status for ${{ matrix.directory }}_${{ env.APP_SUFFIX }}"
          add: "*${{ env.APP_SUFFIX }}.json"
          cwd: ${{ github.event.repository.name }}
          token: ${{ secrets.GITHUB_TOKEN }}
